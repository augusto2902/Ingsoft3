## Trabajo Práctico 8 - Implementación de Contenedores en Azure y Automatización con Azure CLI



### 4- Desarrollo:
#### Prerequisitos:
 - Azure CLI instalado 

#### 4.1 Modificar nuestro pipeline para construir imágenes Docker de back y front y subirlas a ACR
- Desarrollo del punto 4.1: 
	- ##### 4.1.1 Crear archivos DockerFile para nuestros proyectos de Back y Front
   	 ![image](https://github.com/user-attachments/assets/9f974b90-8ce0-4c0f-ac1c-decb17c7839a)

   	- ##### 4.1.2 Crear un recurso ACR en Azure Portal siguiendo el instructivo 5.1
   	  ![image](https://github.com/user-attachments/assets/6ec476df-23a1-41c4-a7e2-97e698ba9646)

  	- ##### 4.1.3 Modificar nuestro pipeline en la etapa de Build y Test
   	
  	- ##### 4.1.4 En caso de no contar en nuestro proyecto con una ServiceConnection a Azure Portal para el manejo de recursos, agregar una service connection a Azure Resource Manager como se indica en instructivo 5.2 

  	- ##### 4.1.5 Agregar a nuestro pipeline variables 


	![image](https://github.com/user-attachments/assets/d76a6555-8150-47fc-a2b8-ac8a165b698c)






  	- ##### 4.1.6 Agregar a nuestro pipeline una nueva etapa que dependa de nuestra etapa de Build y Test
  	  - Agregar tareas para generar imagen Docker de Back

	![image](https://github.com/user-attachments/assets/17529aa1-3cda-4515-9dd5-b9b5d8b4acab)

		




  	- ##### 4.1.7 - Ejecutar el pipeline y en Azure Portal acceder a la opción Repositorios de nuestro recurso Azure Container Registry. Verificar que exista una imagen con el nombre especificado en la variable backImageName asignada en nuestro pipeline

		![image](https://github.com/user-attachments/assets/6ffb0d9e-aca9-4a88-9d9d-8f6bdae71c96)


	- ##### 4.1.8 - Agregar tareas para generar imagen Docker de Front (DESAFIO)
  	  - A la etapa creada en 4.1.6 Agregar tareas para generar imagen Docker de Front
	 ```yaml	
  
  
![image](https://github.com/user-attachments/assets/d81614b4-7408-4b05-88f7-9f511eb39bb8)


- ##### 4.1.9 - Agregar a nuestro pipeline una nueva etapa que dependa de nuestra etapa de Construcción de Imagenes Docker y subida a ACR

  - Agregar variable secreta cnn-string-qa desde la GUI de ADO que apunte a nuestra BD de SQL Server de QA como se indica en el instructivo 5.3

  ![image](https://github.com/user-attachments/assets/63381972-b8de-4fcd-b7eb-7511843d48d6)

   - Agregar tareas para crear un recurso Azure Container Instances que levante un contenedor con nuestra imagen de back
  	  ```yaml
  	  #----------------------------------------------------------
		### STAGE DEPLOY TO ACI QA
		#----------------------------------------------------------
		
		- stage: DeployToACIQA
		  displayName: 'Desplegar en Azure Container Instances (ACI) QA'
		  dependsOn: DockerBuildAndPush
		  jobs:
		    - job: deploy_to_aci_qa
		      displayName: 'Desplegar en Azure Container Instances (ACI) QA'
		      pool:
		        vmImage: 'ubuntu-latest'
		
		      steps:
		        #------------------------------------------------------
		        # DEPLOY DOCKER BACK IMAGE A AZURE CONTAINER INSTANCES QA
		        #------------------------------------------------------
		
		        - task: AzureCLI@2
		          displayName: 'Desplegar Imagen Docker de Back en ACI QA'
		          inputs:
		            azureSubscription: '$(ConnectedServiceName)'
		            scriptType: bash
		            scriptLocation: inlineScript
		            inlineScript: |
		              echo "Resource Group: $(ResourceGroupName)"
		              echo "Container Instance Name: $(backContainerInstanceNameQA)"
		              echo "ACR Login Server: $(acrLoginServer)"
		              echo "Image Name: $(backImageName)"
		              echo "Image Tag: $(backImageTag)"
		              echo "Connection String: $(cnn-string-qa)"
		          
		              az container delete --resource-group $(ResourceGroupName) --name $(backContainerInstanceNameQA) --yes
		
		              az container create --resource-group $(ResourceGroupName) \
		                --name $(backContainerInstanceNameQA) \
		                --image $(acrLoginServer)/$(backImageName):$(backImageTag) \
		                --registry-login-server $(acrLoginServer) \
		                --registry-username $(acrName) \
		                --registry-password $(az acr credential show --name $(acrName) --query "passwords[0].value" -o tsv) \
		                --dns-name-label $(backContainerInstanceNameQA) \
		                --ports 80 \
		                --environment-variables ConnectionStrings__DefaultConnection="$(cnn-string-qa)" \
		                --restart-policy Always \
		                --cpu $(container-cpu-api-qa) \
		                --memory $(container-memory-api-qa)
  	  ```
   - ##### 4.1.10 - Ejecutar el pipeline y en Azure Portal acceder al recurso de Azure Container Instances creado. Copiar la url del contenedor y navegarlo desde browser. Verificar que traiga datos.
   ![image](https://github.com/user-attachments/assets/5585611d-4e61-4c80-983f-e93de9c84125)

  - ##### 4.1.11 - Agregar tareas para generar un recurso Azure Container Instances que levante un contenedor con nuestra imagen de front (DESAFIO)
    se agregaron modificaciones al angular para que funcione
  	  ![image](https://github.com/user-attachments/assets/5cf4f9ab-bf9c-414f-bd40-49f52d339126)

- implementacion de entorno de prod
  	![image](https://github.com/user-attachments/assets/81299702-0436-46ee-a226-083792d289b6)
  	![image](https://github.com/user-attachments/assets/38b7d51e-077d-4e8d-b1f7-e453124b843d)


 ```yaml
  	  #----------------------------------------------------------
  - stage: DeployToACIPROD
  displayName: 'Desplegar en Azure Container Instances (ACI) PROD'
  dependsOn: DeployToACIQA
  jobs:
    - job: deploy_to_aci_prod
      displayName: 'Desplegar en Azure Container Instances (ACI) PROD'
      pool:
        vmImage: 'ubuntu-latest'
        
      steps:

        - task: AzureCLI@2
          displayName: 'Desplegar Imagen Docker de Back en ACI PROD'
          inputs:
            azureSubscription: '$(ConnectedServiceName)'
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              echo "Resource Group: $(ResourceGroupName)"
              echo "Container Instance Name: $(backContainerInstanceNamePROD)"
              echo "ACR Login Server: $(acrLoginServer)"
              echo "Image Name: $(backImageName)"
              echo "Image Tag: $(backImageTag)"
              echo "Connection String: $(cnn_string_prod)"
          
              az container delete --resource-group $(ResourceGroupName) --name $(backContainerInstanceNamePROD) --yes

              az container create --resource-group $(ResourceGroupName) \
                --name $(backContainerInstanceNamePROD) \
                --image $(acrLoginServer)/$(backImageName):$(backImageTag) \
                --registry-login-server $(acrLoginServer) \
                --registry-username $(acrName) \
                --registry-password $(az acr credential show --name $(acrName) --query "passwords[0].value" -o tsv) \
                --dns-name-label $(backContainerInstanceNamePROD) \
                --ports 80 \
                --environment-variables ConnectionStrings__DefaultConnection="$(cnn_string_prod)" \
                --restart-policy Always \
                --cpu $(container-cpu-api-qa) \
                --memory $(container-memory-api-qa)


    - job: deploy_to_aci_qa_front
      displayName: 'Desplegar en Azure Container Instances (ACI) PROD'
      pool:
        vmImage: 'ubuntu-latest'
        
      steps:

        - task: AzureCLI@2
          displayName: 'Desplegar Imagen Docker de Back en ACI PROD'
          inputs:
            azureSubscription: '$(ConnectedServiceName)'
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              echo "Resource Group: $(ResourceGroupName)"
              echo "Container Instance Name: $(frontContainerInstanceNamePROD)"
              echo "ACR Login Server: $(acrLoginServer)"
              echo "Image Name: $(frontImageName)"
              echo "Image Tag: $(frontImageTag)"
              echo "API URL: $(API_URLPROD)"
          
              az container delete --resource-group $(ResourceGroupName) --name $(frontContainerInstanceNamePROD) --yes

              az container create --resource-group $(ResourceGroupName) \
                --name $(frontContainerInstanceNamePROD) \
                --image $(acrLoginServer)/$(frontImageName):$(frontImageTag) \
                --registry-login-server $(acrLoginServer) \
                --registry-username $(acrName) \
                --registry-password $(az acr credential show --name $(acrName) --query "passwords[0].value" -o tsv) \
                --dns-name-label $(frontContainerInstanceNamePROD) \
                --ports 80 \
                --environment-variables API_URL=$(API_URLPROD) \
                --restart-policy Always \
                --cpu $(container-cpu-front-qa) \
                --memory $(container-memory-front-qa)
 ```
es similar solo que con variables de entorno propias

